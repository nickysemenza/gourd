on: [push]

name: rust build + test

env:
  CARGO_TERM_COLOR: always
  SQLX_OFFLINE: true # https://github.com/launchbadge/sqlx/tree/master/sqlx-cli#force-building-in-offline-mode

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        crate: ["common", "w", "s"]
    steps:
      - uses: actions/checkout@v2
      - name: cargo build rust/${{ matrix.crate }}
        run: cargo build --verbose
        working-directory: rust/${{ matrix.crate }}
      - name: cargo test
        run: cargo test --verbose
        working-directory: rust/${{ matrix.crate }}
      - name: Run cargo-tarpaulin
        uses: actions-rs/tarpaulin@v0.1
        with:
          args: -t 120 --root rust/${{ matrix.crate }} -- --test-threads 1
          version: "0.15.0"

      - name: Upload to codecov.io
        uses: codecov/codecov-action@v1.3.2
        with:
          directory: rust/${{ matrix.crate }}
          path_to_write_report: rust/${{ matrix.crate }}/codecov_report.txt
          flags: ${{ matrix.crate }}

      - name: Archive code coverage results
        uses: actions/upload-artifact@v2
        with:
          name: code-coverage-report-${{ matrix.crate }}
          path: |
            rust/${{ matrix.crate }}/target/tarpaulin/coverage.json
            rust/${{ matrix.crate }}/codecov_report.txt
